# OTEL Collector Client
# Collects host metrics and forwards to LGTM stack

services:
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector-client
    restart: unless-stopped
    command: --config=/etc/otelcol/config.yml
    volumes:
      - ./config.yml:/etc/otelcol/config.yml:ro
      # Required for hostmetrics receiver
      - /proc:/hostfs/proc:ro
      - /sys:/hostfs/sys:ro
      - /etc/hostname:/etc/hostname:ro
      - /etc/hosts:/etc/hosts:ro
      - /:/hostfs:ro
    environment:
      - HOST_PROC=/hostfs/proc
      - HOST_SYS=/hostfs/sys
      - HOST_ETC=/hostfs/etc
      - HOST_VAR=/hostfs/var
      - HOST_RUN=/hostfs/run
      - HOST_DEV=/hostfs/dev
      - HOST_FS=/hostfs
    ports:
      - "4317:4317"   # OTLP gRPC (for apps on this host)
      - "4318:4318"   # OTLP HTTP
      - "8888:8888"   # Prometheus metrics
      - "13133:13133" # Health check
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:13133/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
